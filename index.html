<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            cursor: grab;
            background-color: rgba(123, 115, 0, 0.1);
            border: 1px solid rgba(123, 0, 41, 0.5);
        }

        canvas:active {
            cursor: grabbing;
        }
    </style>
</head>

<body>
    <!-- <div style=""> -->
    <canvas id="canvas">
        <canvas id="background-canvas"></canvas>
    </canvas>
    <!-- <canvas id="second-canvas" width="320" height="320"></canvas> -->
    <!-- <canvas id="third-canvas" width="320" height="320"></canvas> -->
    <!-- </div> -->

    <script>
        function trimCanvas(c) {
            var ctx = c.getContext('2d'),
                copy = document.createElement('canvas').getContext('2d'),
                pixels = ctx.getImageData(0, 0, c.width, c.height),
                l = pixels.data.length,
                i,
                bound = {
                    top: null,
                    left: null,
                    right: null,
                    bottom: null
                },
                x, y;

            // Iterate over every pixel to find the highest
            // and where it ends on every axis ()
            for (i = 0; i < l; i += 4) {
                if (pixels.data[i + 3] !== 0) {
                    x = (i / 4) % c.width;
                    y = ~~((i / 4) / c.width);

                    if (bound.top === null) {
                        bound.top = y;
                    }

                    if (bound.left === null) {
                        bound.left = x;
                    } else if (x < bound.left) {
                        bound.left = x;
                    }

                    if (bound.right === null) {
                        bound.right = x;
                    } else if (bound.right < x) {
                        bound.right = x;
                    }

                    if (bound.bottom === null) {
                        bound.bottom = y;
                    } else if (bound.bottom < y) {
                        bound.bottom = y;
                    }
                }
            }

            // Calculate the height and width of the content
            var trimHeight = bound.bottom - bound.top,
                trimWidth = bound.right - bound.left,
                trimmed = ctx.getImageData(bound.left, bound.top, trimWidth, trimHeight);

            copy.canvas.width = trimWidth;
            copy.canvas.height = trimHeight;
            copy.putImageData(trimmed, 0, 0);

            // Return trimmed canvas
            return copy.canvas;
        }

        const canvas = document.getElementById("canvas")
        const ctx = canvas.getContext("2d", { willReadFrequently: true })
        
        const getCanvasOffset = (canvas) => canvas.getBoundingClientRect()
        
        const getCanvasPosition = (event, canvasOffset) => {
            return {
                x: Math.ceil(event.clientX - canvasOffset.left),
                y: Math.ceil(event.clientY - canvasOffset.top)
            }
        }

        let img = new Image();
        img.src = "res/inventory.png"

        canvas.width = img.width * 2;
        canvas.height = img.height * 2;

        img.onload = () => {
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(img, 0, 0);
        }

        let canvasOffset = getCanvasOffset(canvas);

        let isMouseDown = false;
        let startX, startY;

        canvas.addEventListener('mousedown', (e) => {
            // e.preventDefault();
            // e.stopPropagation();

            isMouseDown = true;
            ({ x: startX, y: startY } = getCanvasPosition(e, canvasOffset));
        })

        let panningX = 0;
        let panningY = 0; 

        canvas.addEventListener('mousemove', (e) => {
            // e.preventDefault();
            // e.stopPropagation();

            if (isMouseDown) {
                const { x, y } = getCanvasPosition(e, canvasOffset);

                panningX += x - startX;
                panningY += y - startY;

                startX = x;
                startY = y;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.save();
                ctx.translate(panningX, panningY);
                ctx.restore();

                ctx.drawImage(img, panningX, panningY);

            } else return
        })

        window.addEventListener('mouseup', (e) => {
            // e.preventDefault();
            // e.stopPropagation();

            isMouseDown = false;
        })


        canvas.addEventListener('mouseout', (e) => {
            // e.preventDefault();
            // e.stopPropagation();

            if(isMouseDown)
                isMouseDown = true;
        })

        window.onresize = (e) => {
            getCanvasOffset(canvas);
        }

        window.onscroll = (e) => {
            getCanvasOffset(canvas);
        }

    </script>
</body>

</html>